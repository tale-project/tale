# Tale DB PostgreSQL Configuration
# Custom configuration for TimescaleDB optimized for Tale platform
# This file is loaded in addition to the default PostgreSQL configuration

# ============================================================================
# Connection Settings
# ============================================================================
# Listen on all network interfaces (required for Docker networking)
listen_addresses = '*'

# Maximum number of concurrent connections
# Controlled by DB_MAX_CONNECTIONS environment variable
# max_connections = 100

# ============================================================================
# Memory Settings
# ============================================================================
# Shared memory for caching data
# Controlled by DB_SHARED_BUFFERS environment variable
# Recommended: 25% of system RAM for dedicated DB server
# shared_buffers = 256MB

# Memory for maintenance operations (VACUUM, CREATE INDEX, etc.)
# Controlled by DB_MAINTENANCE_WORK_MEM environment variable
# maintenance_work_mem = 64MB

# Memory for query operations (sorts, hash tables)
# Controlled by DB_WORK_MEM environment variable
# work_mem = 4MB

# Estimate of memory available for disk caching
# Controlled by DB_EFFECTIVE_CACHE_SIZE environment variable
# Recommended: 50-75% of system RAM
# effective_cache_size = 1GB

# ============================================================================
# Write-Ahead Log (WAL) Settings
# ============================================================================
# WAL level for replication and point-in-time recovery
wal_level = replica

# Minimum number of WAL files to keep
min_wal_size = 80MB
max_wal_size = 1GB

# ============================================================================
# Query Tuning
# ============================================================================
# Enable parallel query execution
max_parallel_workers_per_gather = 2
max_parallel_workers = 4

# Random page cost (lower for SSD)
random_page_cost = 1.1

# ============================================================================
# Logging
# ============================================================================
# Log destination
log_destination = 'stderr'

# Log collector settings
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# What to log
# Controlled by DB_LOG_STATEMENT environment variable
# log_statement = 'none'  # none, ddl, mod, all

# Log slow queries
# Controlled by DB_LOG_MIN_DURATION_STATEMENT environment variable
# -1 disables, 0 logs all, >0 logs queries taking longer than N milliseconds
# log_min_duration_statement = -1

# Log line prefix
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Log connections and disconnections
log_connections = on
log_disconnections = on

# ============================================================================
# TimescaleDB Settings
# ============================================================================
# Disable telemetry
# Controlled by DB_TIMESCALEDB_TELEMETRY environment variable
# timescaledb.telemetry_level = off

# TimescaleDB background workers
timescaledb.max_background_workers = 8

# ============================================================================
# Statistics
# ============================================================================
# Enable query statistics collection
shared_preload_libraries = 'timescaledb,pg_stat_statements'

# Track query statistics
pg_stat_statements.track = all
pg_stat_statements.max = 10000

# ============================================================================
# Autovacuum
# ============================================================================
# Enable autovacuum for automatic maintenance
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# ============================================================================
# Client Connection Defaults
# ============================================================================
# Timezone
timezone = 'UTC'

# Character encoding
client_encoding = 'UTF8'

# Locale settings
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Default transaction isolation level
default_transaction_isolation = 'read committed'

