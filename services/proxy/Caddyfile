# Caddy Configuration for Tale Platform
# Single entry point for both local development and production
#
# Local dev: http://localhost:3000
# Production: https://yourdomain.com (automatic HTTPS via Let's Encrypt)

{$DOMAIN:http://localhost} {
	# TLS/ACME configuration - only applies to domains that qualify for ACME
	# localhost will use HTTP only
	@needsTLS not host *.test *.local *.localhost localhost 127.0.0.1
	tls {
		issuer acme {
			dir {$ACME_CA:https://acme-v02.api.letsencrypt.org/directory}
			disable_tlsalpn_challenge
		}
	}

	log {
		output stdout
		format console
		level INFO
	}

	reverse_proxy platform:3000 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}

		health_uri /api/health
		health_interval 30s
		health_timeout 10s
	}

	encode gzip zstd

	header {
		-Server
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Only set HSTS for HTTPS connections
	@https {
		protocol https
	}
	header @https Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
}
