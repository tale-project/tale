# Caddy Configuration for Tale Platform
# Single entry point for both local development and production
#
# Supports blue-green deployments with automatic health-based routing
#
# TLS Configuration (environment variables):
# - TLS_MODE: Certificate mode
#   - "selfsigned" (default): Self-signed certificates via Caddy's internal CA
#   - "letsencrypt": Free trusted certificates from Let's Encrypt
#
# - TLS_EMAIL: Email for Let's Encrypt notifications (optional but recommended)
#
# Users always access via HTTPS regardless of TLS mode.
#
# Development: https://tale.local (TLS_MODE=selfsigned)
# Production:  https://yourdomain.com (TLS_MODE=letsencrypt)
#
# Blue-Green Deployment:
# - Both platform-blue:3000 and platform-green:3000 are listed as upstreams
# - Caddy automatically routes to healthy backends based on health checks
# - During deployment, traffic seamlessly switches to the healthy version

# Global options
{
	default_sni {$HOST:tale.local}
}

# HTTP health check endpoint (for Docker healthcheck)
# This avoids SSL issues when checking from localhost
:80 {
	handle /health {
		respond "OK" 200
	}
	# Redirect all other HTTP traffic to HTTPS
	handle {
		redir https://{host}{uri} permanent
	}
}

{$SITE_URL:https://tale.local} {
	# TLS Configuration - This line is replaced by entrypoint based on TLS_MODE
	# DO NOT MODIFY - entrypoint will replace this placeholder
	# TLS_PLACEHOLDER

	log {
		output stdout
		format console
		level INFO
	}

	# Remove WebSocket compression extension header before proxying
	# This prevents "Invalid frame header" errors caused by permessage-deflate
	# compression negotiation issues between browser, Caddy, and backend
	request_header -Sec-WebSocket-Extensions

	# Health check endpoint for the proxy itself
	handle /health {
		respond "OK" 200
	}

	# ============================================================================
	# Direct Convex Proxies (bypass Express for better WebSocket stability)
	# ============================================================================

	# WebSocket: Main app Convex sync (/ws_api/* -> platform:3210)
	handle /ws_api/* {
		uri strip_prefix /ws_api
		reverse_proxy platform:3210
	}

	# WebSocket: Dashboard Convex sync (/api/:version/sync -> platform:3210)
	handle /api/*/sync {
		reverse_proxy platform:3210
	}

	# HTTP: Convex site proxy for actions (/http_api/* -> platform:3211)
	handle /http_api/* {
		uri strip_prefix /http_api
		reverse_proxy platform:3211
	}

	# HTTP: better-auth (/api/auth/* -> platform:3211)
	handle /api/auth/* {
		reverse_proxy platform:3211
	}

	# HTTP: Convex Dashboard UI (/convex-dashboard/* -> platform:6791)
	handle /convex-dashboard/* {
		reverse_proxy platform:6791
	}

	# HTTP: Convex internal action callbacks (/api/actions/* -> platform:3210)
	handle /api/actions/* {
		reverse_proxy platform:3210
	}

	# HTTP: Convex API with admin auth header (Dashboard API calls)
	@convexAdminApi {
		path /api/*
		not path /api/auth/*
		not path /api/*/sync
		not path /api/health
		not path /api/actions/*
		header Authorization Convex*
	}
	handle @convexAdminApi {
		reverse_proxy platform:3210
	}

	# ============================================================================
	# Express Server (static files + HTML env injection only)
	# ============================================================================

	# Default: Express server for static files and index.html with env injection
	reverse_proxy platform:3000 {
		# Active health checking
		health_uri /api/health
		health_interval 2s
		health_timeout 2s
		health_status 200
		health_passes 2

		# Passive health checking (circuit breaker)
		fail_duration 10s
		max_fails 2
		unhealthy_status 500 502 503 504

		# Retry on failure
		lb_try_duration 5s
		lb_try_interval 250ms

		# Headers
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	# Encode responses, but skip WebSocket endpoints
	@notWebSocket {
		not path /api/*/sync
		not path /ws_api/*
	}
	encode @notWebSocket gzip zstd

	# Maintenance page when no healthy backends available
	# During blue-green deployments, there's a brief window (~8-10s) when
	# the old backend loses its database lease and the new one isn't ready yet.
	# This shows a friendly loading page instead of a raw 503 error.
	handle_errors 502 503 504 {
		root * /var/www
		rewrite * /maintenance.html
		file_server
	}

	header {
		-Server
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Only set HSTS for HTTPS connections
	@https {
		protocol https
	}
	header @https Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
}
