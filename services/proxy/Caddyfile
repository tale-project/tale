# Caddy Configuration for Tale Platform
# Single entry point for both local development and production
#
# Supports blue-green deployments with automatic health-based routing
#
# Local dev: http://localhost
# Production: https://yourdomain.com (automatic HTTPS via Let's Encrypt)
#
# Blue-Green Deployment:
# - Both platform-blue:3000 and platform-green:3000 are listed as upstreams
# - Caddy automatically routes to healthy backends based on health checks
# - During deployment, traffic seamlessly switches to the healthy version

{$DOMAIN:http://localhost} {
	# TLS/ACME configuration - only applies to domains that qualify for ACME
	# localhost will use HTTP only
	@needsTLS not host *.test *.local *.localhost localhost 127.0.0.1
	tls {
		issuer acme {
			dir {$ACME_CA:https://acme-v02.api.letsencrypt.org/directory}
			disable_tlsalpn_challenge
		}
	}

	log {
		output stdout
		format console
		level INFO
	}

	# Blue-Green Upstream Pool
	# Both backends are listed; Caddy routes to healthy ones based on health checks
	# For local development without blue-green, "platform:3000" works as fallback
	reverse_proxy {
		# Upstream backends - order matters for lb_policy first
		# Blue is preferred when both are healthy (listed first)
		to platform-blue:3000 platform-green:3000 platform:3000

		# Load balancing policy: use first healthy backend
		# This ensures deterministic behavior during deployments
		lb_policy first

		# Active health checking - Caddy probes these endpoints
		health_uri /api/health
		health_interval 3s
		health_timeout 2s
		health_status 200

		# Passive health checking (circuit breaker)
		# Mark backend unhealthy after consecutive failures
		fail_duration 10s
		max_fails 3
		unhealthy_status 500 502 503 504

		# Retry on failure - try other backends
		lb_try_duration 5s
		lb_try_interval 250ms

		# Headers
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}

	encode gzip zstd

	header {
		-Server
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Only set HSTS for HTTPS connections
	@https {
		protocol https
	}
	header @https Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
}
