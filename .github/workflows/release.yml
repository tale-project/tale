name: Release All Services

# ============================================================================
# Unified Release Workflow
# ============================================================================
# Triggered by version tags (v*.*.* or *.*.*) to build and push all 7 service
# images with the same version number. Uses native ARM/AMD64 runners for
# faster builds without QEMU emulation.
#
# Usage:
#   git tag v1.0.0 && git push origin v1.0.0
#
# This will build and push multi-arch images:
#   - ghcr.io/tale-project/tale/tale-platform:1.0.0
#   - ghcr.io/tale-project/tale/tale-rag:1.0.0
#   - ghcr.io/tale-project/tale/tale-crawler:1.0.0
#   - ghcr.io/tale-project/tale/tale-db:1.0.0
#   - ghcr.io/tale-project/tale/tale-graph-db:1.0.0
#   - ghcr.io/tale-project/tale/tale-proxy:1.0.0
#   - ghcr.io/tale-project/tale/tale-operator:1.0.0
#   - CLI binaries (via cli.yml workflow)
# ============================================================================

on:
  push:
    tags:
      - 'v*.*.*'
      - '[0-9]*.*.*'

  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  # ============================================================================
  # Compute version from tag or input
  # ============================================================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_number: ${{ steps.version.outputs.version_number }}

    steps:
      - name: Compute version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          VERSION_NUMBER="${VERSION#v}"
          echo "version=v${VERSION_NUMBER}" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION_NUMBER}" >> $GITHUB_OUTPUT

      - name: Log version
        run: |
          echo "## Release Version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Number**: ${{ steps.version.outputs.version_number }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  create-release:
    name: Create Release
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ needs.prepare.outputs.version }} \
            --title "Tale ${{ needs.prepare.outputs.version }}" \
            --generate-notes \
            || echo "Release already exists, skipping creation"

  # ============================================================================
  # Build all services on native runners (no QEMU)
  # ============================================================================
  build:
    name: Build ${{ matrix.service }} (${{ matrix.arch }})
    needs: prepare
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        service:
          - name: platform
            dockerfile: services/platform/Dockerfile
            context: .
          - name: rag
            dockerfile: services/rag/Dockerfile
            context: .
          - name: crawler
            dockerfile: services/crawler/Dockerfile
            context: .
          - name: db
            dockerfile: services/db/Dockerfile
            context: .
          - name: graph-db
            dockerfile: services/graph-db/Dockerfile
            context: services/graph-db
          - name: proxy
            dockerfile: services/proxy/Dockerfile
            context: .
          - name: operator
            dockerfile: services/operator/Dockerfile
            context: .
        arch:
          - name: amd64
            runner: ubuntu-latest
            platform: linux/amd64
          - name: arm64
            runner: ubuntu-24.04-arm
            platform: linux/arm64
        exclude: []
        include: []

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Free disk space
        if: matrix.service.name == 'platform' || matrix.service.name == 'rag' || matrix.service.name == 'crawler'
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          platforms: ${{ matrix.arch.platform }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-${{ matrix.service.name }}:${{ needs.prepare.outputs.version_number }}-${{ matrix.arch.name }}
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha,scope=${{ matrix.service.name }}-${{ matrix.arch.name }}
          cache-to: type=gha,scope=${{ matrix.service.name }}-${{ matrix.arch.name }},mode=max
          provenance: false

  # ============================================================================
  # Create multi-arch manifests
  # ============================================================================
  manifest:
    name: Create Manifest (${{ matrix.service }})
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      packages: write

    strategy:
      matrix:
        service: [platform, rag, crawler, db, graph-db, proxy, operator]

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository }}/tale-${{ matrix.service }}"
          VERSION="${{ needs.prepare.outputs.version_number }}"

          docker manifest create ${IMAGE}:${VERSION} \
            ${IMAGE}:${VERSION}-amd64 \
            ${IMAGE}:${VERSION}-arm64

          docker manifest create ${IMAGE}:latest \
            ${IMAGE}:${VERSION}-amd64 \
            ${IMAGE}:${VERSION}-arm64

          docker manifest push ${IMAGE}:${VERSION}
          docker manifest push ${IMAGE}:latest

  # ============================================================================
  # Trigger CLI build
  # ============================================================================
  trigger-cli:
    name: Trigger CLI Build
    needs: [prepare, create-release]
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Trigger CLI workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run cli.yml \
            --repo ${{ github.repository }} \
            --field release_tag=${{ needs.prepare.outputs.version }}

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Release Summary
    needs:
      - prepare
      - create-release
      - manifest
      - trigger-cli
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        run: |
          echo "## Release ${{ needs.prepare.outputs.version }} Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All 7 service images have been built and pushed to GHCR (native amd64 + arm64)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-platform:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| RAG | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-rag:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Crawler | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-crawler:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| DB | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-db:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Graph DB | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-graph-db:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Proxy | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-proxy:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Operator | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-operator:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CLI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CLI build workflow has been triggered with tag \`${{ needs.prepare.outputs.version }}\`." >> $GITHUB_STEP_SUMMARY
          echo "The CLI binaries will be uploaded to the release once the build completes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deploy Command" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "./scripts/deploy.sh deploy ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
