name: Release All Services

# ============================================================================
# Unified Release Workflow
# ============================================================================
# Triggered by version tags (v*.*.* or *.*.*) to build and push all 7 service
# images with the same version number. This ensures consistent versioning
# across the entire Tale platform. Also triggers CLI build workflow.
#
# Usage:
#   git tag v1.0.0 && git push origin v1.0.0
#   git tag 1.0.0 && git push origin 1.0.0
#
# This will build and push:
#   - ghcr.io/tale-project/tale/tale-platform:1.0.0
#   - ghcr.io/tale-project/tale/tale-rag:1.0.0
#   - ghcr.io/tale-project/tale/tale-crawler:1.0.0
#   - ghcr.io/tale-project/tale/tale-db:1.0.0
#   - ghcr.io/tale-project/tale/tale-graph-db:1.0.0
#   - ghcr.io/tale-project/tale/tale-proxy:1.0.0
#   - ghcr.io/tale-project/tale/tale-search:1.0.0
#   - CLI binaries (via cli.yml workflow)
# ============================================================================

on:
  push:
    tags:
      - 'v*.*.*'
      - '[0-9]*.*.*'

  # Manual trigger for re-releasing a version
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  # ============================================================================
  # Compute version from tag or input
  # ============================================================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_number: ${{ steps.version.outputs.version_number }}

    steps:
      - name: Compute version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # Normalize: strip 'v' prefix first, then add it back
          VERSION_NUMBER="${VERSION#v}"
          # version includes 'v' prefix (e.g., v1.0.0)
          echo "version=v${VERSION_NUMBER}" >> $GITHUB_OUTPUT
          # version_number excludes 'v' prefix (e.g., 1.0.0)
          echo "version_number=${VERSION_NUMBER}" >> $GITHUB_OUTPUT

      - name: Log version
        run: |
          echo "## Release Version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Number**: ${{ steps.version.outputs.version_number }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Build all services in parallel
  # ============================================================================
  build-platform:
    name: Build Platform
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/platform/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-platform:${{ needs.prepare.outputs.version_number }}
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-platform:latest
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

  build-rag:
    name: Build RAG
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/rag/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-rag:${{ needs.prepare.outputs.version_number }}
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-rag:latest
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

  build-crawler:
    name: Build Crawler
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/crawler/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-crawler:${{ needs.prepare.outputs.version_number }}
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-crawler:latest
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

  build-db:
    name: Build DB
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/db/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-db:${{ needs.prepare.outputs.version_number }}
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-db:latest
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

  build-graph-db:
    name: Build Graph DB
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: services/graph-db
          file: services/graph-db/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-graph-db:${{ needs.prepare.outputs.version_number }}
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-graph-db:latest
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

  build-proxy:
    name: Build Proxy
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/proxy/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-proxy:${{ needs.prepare.outputs.version_number }}
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-proxy:latest
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

  build-search:
    name: Build Search
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: services/search/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-search:${{ needs.prepare.outputs.version_number }}
            ${{ env.REGISTRY }}/${{ github.repository }}/tale-search:latest
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

  # ============================================================================
  # Trigger CLI build
  # ============================================================================
  trigger-cli:
    name: Trigger CLI Build
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: Trigger CLI workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run cli.yml \
            --repo ${{ github.repository }} \
            --field release_tag=${{ needs.prepare.outputs.version }}

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Release Summary
    needs:
      - prepare
      - build-platform
      - build-rag
      - build-crawler
      - build-db
      - build-graph-db
      - build-proxy
      - build-search
      - trigger-cli
    runs-on: ubuntu-latest

    steps:
      - name: Generate summary
        run: |
          echo "## Release ${{ needs.prepare.outputs.version }} Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All 7 service images have been built and pushed to GHCR." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-platform:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| RAG | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-rag:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Crawler | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-crawler:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| DB | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-db:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Graph DB | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-graph-db:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Proxy | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-proxy:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Search | \`${{ env.REGISTRY }}/${{ github.repository }}/tale-search:${{ needs.prepare.outputs.version_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CLI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CLI build workflow has been triggered with tag \`${{ needs.prepare.outputs.version }}\`." >> $GITHUB_STEP_SUMMARY
          echo "The CLI binaries will be uploaded to the release once the build completes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deploy Command" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "./scripts/deploy.sh deploy ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
