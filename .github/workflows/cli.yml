name: Build Tale CLI

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to attach binary to (e.g., v1.0.0)'
        required: true
        type: string
  push:
    branches:
      - main
    paths:
      - 'tools/cli/**'
      - '.github/workflows/cli.yml'

permissions:
  contents: write

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            VERSION="${{ github.event.inputs.release_tag }}"
          else
            VERSION="dev"
          fi
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build:
    name: Build (${{ matrix.platform }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            build_script: build:linux
            binary: tale
            artifact: tale_linux
          - os: macos-latest
            platform: macos
            build_script: build:mac
            binary: tale
            artifact: tale_macos
          - os: windows-latest
            platform: windows
            build_script: build:windows
            binary: tale.exe
            artifact: tale_windows.exe

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: tools/cli
        run: bun install

      - name: Type check
        if: matrix.platform == 'linux'
        working-directory: tools/cli
        run: bun run typecheck

      - name: Inject version into package.json
        working-directory: tools/cli
        shell: bash
        run: |
          if command -v jq &>/dev/null; then
            jq '.version = "${{ needs.prepare.outputs.version }}"' package.json > package.json.tmp
            mv package.json.tmp package.json
          else
            # Windows fallback using node
            node -e "const fs=require('fs');const p=JSON.parse(fs.readFileSync('package.json'));p.version='${{ needs.prepare.outputs.version }}';fs.writeFileSync('package.json',JSON.stringify(p,null,2))"
          fi

      - name: Build binary
        working-directory: tools/cli
        run: bun run ${{ matrix.build_script }}

      - name: Rename binary (Unix)
        if: matrix.platform != 'windows'
        working-directory: tools/cli/dist
        run: |
          mv ${{ matrix.binary }} tale_${{ needs.prepare.outputs.version }}_${{ matrix.platform }}
          cp tale_${{ needs.prepare.outputs.version }}_${{ matrix.platform }} ${{ matrix.artifact }}

      - name: Rename binary (Windows)
        if: matrix.platform == 'windows'
        working-directory: tools/cli/dist
        shell: bash
        run: |
          mv ${{ matrix.binary }} tale_${{ needs.prepare.outputs.version }}_windows.exe
          cp tale_${{ needs.prepare.outputs.version }}_windows.exe ${{ matrix.artifact }}

      - name: Verify binary
        working-directory: tools/cli/dist
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" != "windows" ]; then
            chmod +x tale_${{ needs.prepare.outputs.version }}_${{ matrix.platform }}
            ./tale_${{ needs.prepare.outputs.version }}_${{ matrix.platform }} --version
          else
            ./tale_${{ needs.prepare.outputs.version }}_windows.exe --version
          fi

      - name: Upload versioned artifact
        uses: actions/upload-artifact@v6
        with:
          name: tale_${{ needs.prepare.outputs.version }}_${{ matrix.platform }}
          path: tools/cli/dist/tale_${{ needs.prepare.outputs.version }}_${{ matrix.platform }}${{ matrix.platform == 'windows' && '.exe' || '' }}
          retention-days: 30

      - name: Upload stable artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact }}
          path: tools/cli/dist/${{ matrix.artifact }}
          retention-days: 30

  release:
    name: Upload to Release
    needs: [prepare, build]
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.inputs.release_tag }} \
            artifacts/tale_${{ needs.prepare.outputs.version }}_linux/* \
            artifacts/tale_${{ needs.prepare.outputs.version }}_macos/* \
            artifacts/tale_${{ needs.prepare.outputs.version }}_windows/* \
            artifacts/tale_linux/* \
            artifacts/tale_macos/* \
            artifacts/tale_windows.exe/* \
            --repo ${{ github.repository }} \
            --clobber
